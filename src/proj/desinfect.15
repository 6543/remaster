#!/bin/bash
#remaster lib
[ -d "<LIBDIR>" ] || { echo "LIBDIR not exist"; exit 1; }

#desinfect.15
# . -Y ubuntu.14.04 -> ubuntu -> debian
source <LIBDIR>/proj/ubuntu.14.04
project_relation="desinfect.15 $project_relation"



#iso_create-desinfect.15 [chroot_path] [iso_extr_dir] [iso_aim] [iso_lable]
function iso_create-desinfect.15() {
  echo "prepere iso folder ... "

  chroot_path="$1"
  iso_extr_dir="$2"
  iso_aim="$3"
  iso_lable="$4"

  #desinfect
  rm "$iso_extr_dir/casper/initrd.lz"
  wget http://www.heise.de/ct/projekte/desinfect/des15/initrd.lz -O "$iso_extr_dir/casper/initrd.lz"

  echo "done"

  iso_create-debian  "$chroot_path" "$iso_extr_dir" "$iso_aim" "$iso_lable"
}
function iso_create() { iso_create-desinfect.15 $@; }

#chroot_initial-desinfect.15 [chroot_dir]
function chroot_initial-desinfect.15() {
  #$1 = chroot dir

  chroot_initial-debian "$1"

  echo -n "initial desinfect on chroot ... "

  #check chroot dir
  chroot_dir="$1"
  [ -d "$chroot_dir" ] || {
    echo "### ERROR ### chroot_initial_desinfect: chroot directory not exist!"
    return 12
  }

  #mount virus definitions
  #bitdefender
  mount --bind $chroot_dir/opt/BitDefender-scanner/var/lib/scan{.orig,}
  mount --bind $chroot_dir/var/kl/bases_rd{.orig,}

  echo "done"
}
function iso_create() { iso_create-desinfect.15 $@; }

#chroot_umount-desinfect.15 [chroot_dir]
function chroot_umount-desinfect.15() {
  #call main mount
  chroot_umount-debian "$1"

  echo -n "unmount desinfect on chroot ... "
  #check chroot dir
  chroot_dir="$1"
  [ -d "$chroot_dir" ] || {
    echo "### ERROR ### chroot_umount_desinfect: chroot directory not exist!"
    return 12
  }

  for d in "$chroot_dir/opt/BitDefender-scanner/var/lib/scan" "$chroot_dir/var/kl/bases_rd" ; do
    umount $d
    retval=$?
    [ "$retval" -gt 0 ] && {
      echo "### ERROR ### chroot_umount_desinfect: can't umount \"$d\"!"
      return 21
    }
  done

  echo "done"
}
function chroot_umount() { chroot_umount-desinfect.15 $@; }

#proxy_enable-desinfect.15 [chroot_dir] [proxy_host] [proxy_port]
function proxy_enable-desinfect.15() {

  proxy_enable-debian $1 $2 $3

  echo -n "enable proxy for desinfect's av ... "

  chroot_dir="$1"
  proxy_host="$2"
  proxy_port="$3"

  #Avast AntiVirus
  sed -i "s/--skip-master-file/--skip-master-file --proxy-host=$proxy_host --proxy-port=$proxy_port/g" "$chroot_dir/AntiVirUpdate/avupdate"
  sed -i "s/--proxy-host=$proxy_host --proxy-port=$proxy_port --proxy-host=$proxy_host --proxy-port=$proxy_port/--proxy-host=$proxy_host --proxy-port=$proxy_port/g" "$chroot_dir/AntiVirUpdate/avupdate"

  #BitDefender
  echo "ProxyEnable = Yes" >> "$chroot_dir/etc/BitDefender-scanner/bdscan.conf"
  echo "ProxyHost = $proxy_host:$proxy_port" >> "$chroot_dir/etc/BitDefender-scanner/bdscan.conf"

  #Clam AV
  echo "HTTPProxyServer $proxy_host" >> "$chroot_dir/etc/clamav/freshclam.conf"
  echo "HTTPProxyPort $proxy_port" >> "$chroot_dir/etc/clamav/freshclam.conf"

  #Kaspersky
  sed -i "s/<tDWORD name=\"UseProxy\">0<\/tDWORD>/<tDWORD name=\"UseProxy\">1<\/tDWORD>/g" "$chroot_dir/etc/kl/config.xml"
  sed -i "s/<tSTRING name=\"ProxyHost\"><\/tSTRING>/<tSTRING name=\"ProxyHost\">$proxy_host<\/tSTRING>/g" "$chroot_dir/etc/kl/config.xml"
  sed -i "s/<tDWORD name=\"ProxyPort\"><\/tDWORD>/<tDWORD name=\"ProxyPort\">$proxy_port<\/tDWORD>/g" "$chroot_dir/etc/kl/config.xml"

  echo "done"
}
function proxy_enable() { proxy_enable-desinfect.15 $@; }

#sourcelist_desinfect_set_nomal2015 [chroot_dir]
function sourcelist_desinfect_set_nomal2015() {
  echo -n "build normal source.list ... "
  #$1 = chroot directory

  sourcelist="$1/etc/apt/sources.list"


  echo "#### Desinfe't 2015 ####" > "$sourcelist"
  echo "" >> "$sourcelist"
  echo "deb http://www.heise.de/ct/projekte/desinfect/ubuntu 2015 main" >> "$sourcelist"
  echo "" >> "$sourcelist"
  echo "" >> "$sourcelist"
  echo "# #### Ubuntu 14.04 (trusty) ####" >> "$sourcelist"
  echo "#" >> "$sourcelist"
  echo "# deb http://de.archive.ubuntu.com/ubuntu trusty main restricted universe multiverse" >> "$sourcelist"
  echo "# deb-src http://de.archive.ubuntu.com/ubuntu trusty main restricted universe multiverse" >> "$sourcelist"
  echo "#" >> "$sourcelist"
  echo "# deb http://de.archive.ubuntu.com/ubuntu trusty-updates main restricted universe multiverse" >> "$sourcelist"
  echo "# deb-src http://de.archive.ubuntu.com/ubuntu trusty-updates main restricted universe multiverse" >> "$sourcelist"
  echo "#" >> "$sourcelist"
  echo "# deb http://de.archive.ubuntu.com/ubuntu trusty-security main restricted universe multiverse" >> "$sourcelist"
  echo "# deb-src http://de.archive.ubuntu.com/ubuntu trusty-security main restricted universe multiverse" >> "$sourcelist"
  echo "#" >> "$sourcelist"
  echo "# deb http://de.archive.ubuntu.com/ubuntu trusty-backports main restricted universe multiverse" >> "$sourcelist"
  echo "# deb-src http://de.archive.ubuntu.com/ubuntu trusty-backports main restricted universe multiverse" >> "$sourcelist"
  echo "#" >> "$sourcelist"
  echo "# ## This software is not part of Ubuntu, but is offered by third-party" >> "$sourcelist"
  echo "# ## developers who want to ship their latest software." >> "$sourcelist"
  echo "# deb http://extras.ubuntu.com/ubuntu trusty main" >> "$sourcelist"

  echo "done"
}

#sourcelist_desinfect_set_extendet2015 [chroot_dir]
function sourcelist_desinfect_set_extendet2015() {
  echo -n "build extendet source.list ... "

  sourcelist="$1/etc/apt/sources.list"


  echo "#### Desinfe't 2015 ####" > "$sourcelist"
  echo "" >> "$sourcelist"
  echo "deb http://www.heise.de/ct/projekte/desinfect/ubuntu 2015 main" >> "$sourcelist"
  echo "" >> "$sourcelist"
  echo "" >> "$sourcelist"
  echo "#### Ubuntu 14.04 (trusty) ####" >> "$sourcelist"
  echo "" >> "$sourcelist"
  echo "deb http://de.archive.ubuntu.com/ubuntu trusty main restricted universe multiverse" >> "$sourcelist"
  echo "deb-src http://de.archive.ubuntu.com/ubuntu trusty main restricted universe multiverse" >> "$sourcelist"
  echo "" >> "$sourcelist"
  echo "deb http://de.archive.ubuntu.com/ubuntu trusty-updates main restricted universe multiverse" >> "$sourcelist"
  echo "deb-src http://de.archive.ubuntu.com/ubuntu trusty-updates main restricted universe multiverse" >> "$sourcelist"
  echo "" >> "$sourcelist"
  echo "deb http://de.archive.ubuntu.com/ubuntu trusty-security main restricted universe multiverse" >> "$sourcelist"
  echo "deb-src http://de.archive.ubuntu.com/ubuntu trusty-security main restricted universe multiverse" >> "$sourcelist"
  echo "" >> "$sourcelist"
  echo "deb http://de.archive.ubuntu.com/ubuntu trusty-backports main restricted universe multiverse" >> "$sourcelist"
  echo "deb-src http://de.archive.ubuntu.com/ubuntu trusty-backports main restricted universe multiverse" >> "$sourcelist"
  echo "" >> "$sourcelist"
  echo "## This software is not part of Ubuntu, but is offered by third-party" >> "$sourcelist"
  echo "## developers who want to ship their latest software." >> "$sourcelist"
  echo "deb http://extras.ubuntu.com/ubuntu trusty main" >> "$sourcelist"

  echo "done"
}

#os_update-desinfect.15 [chroot_dir]
function os_update-desinfect.15() {
  #$1 = chroot directory

  chroot_dir="$1"

  #call main os_update
  os_update-debian "$chroot_dir"

  echo "update virus definitions ... "

  #BitDefender
  chroot "$chroot_dir" /bin/bash -c "bdscan --update" | grep -v "... updated"

  #Avast Avira
  chroot "$chroot_dir" /bin/bash -c "/AntiVirUpdate/avupdate" | grep -v " -> "

  #Clam AV
  chroot "$chroot_dir" /bin/bash -c "freshclam" > /dev/null
  rm -f "$chroot_dir/var/lib/clamav/daily.cld"

  #Karspersky
  echo '#!/bin/bash' > "$chroot_dir/tmp/up_kasp"
  echo 'PATH=/usr/lib/kl:$PATH' >> "$chroot_dir/tmp/up_kasp"
  echo 'LD_LIBRARY_PATH=/usr/lib/kl:$LD_LIBRARY_PATH' >> "$chroot_dir/tmp/up_kasp"
  echo 'KL_PLUGINS_PATH=/usr/lib/kl' >> "$chroot_dir/tmp/up_kasp"
  echo 'export PATH LD_LIBRARY_PATH KL_PLUGINS_PATH' >> "$chroot_dir/tmp/up_kasp"
  echo '/usr/lib/kl/kav update' >> "$chroot_dir/tmp/up_kasp"
  chmod +x  "$chroot_dir/tmp/up_kasp"
  chroot "$chroot_dir" /bin/bash -c "/tmp/up_kasp" | grep -v ".kdc" | grep -v "File downloaded"
  rm "$chroot_dir/tmp/up_kasp"


  echo "done"
}
function os_update() { os_update-desinfect.15 $@; }

#tools_add-desinfect.15 [chroot_dir] [tools_list]
function tools_add-desinfect.15() {
  #$1 = chroot directory
  chroot_dir="$1"
  tools_list="$2"

  sourcelist_desinfect_set_extendet2015 "$chroot_dir"
  tools_add-debian "$chroot_dir" "$tools_list"
  sourcelist_desinfect_set_nomal2015 "$chroot_dir"
}
function tools_add() { tools_add-desinfect.15 $@; }
